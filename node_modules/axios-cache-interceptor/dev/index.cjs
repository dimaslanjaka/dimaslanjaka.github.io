(()=>{"use strict";var e={d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Header:()=>r,buildKeyGenerator:()=>S,buildMemoryStorage:()=>b,buildStorage:()=>v,buildWebStorage:()=>C,canStale:()=>p,createCacheResponse:()=>c,createValidateStatus:()=>i,defaultHeaderInterpreter:()=>n,defaultKeyGenerator:()=>I,defaultRequestInterceptor:()=>u,defaultResponseInterceptor:()=>f,isExpired:()=>m,isMethodIn:()=>s,isStorage:()=>h,setupCache:()=>x,testCachePredicate:()=>l,updateCache:()=>g,updateStaleRequest:()=>d});const a=require("cache-parser"),r=Object.freeze({IfModifiedSince:"if-modified-since",LastModified:"last-modified",IfNoneMatch:"if-none-match",CacheControl:"cache-control",Pragma:"pragma",ETag:"etag",Expires:"expires",Age:"age",XAxiosCacheEtag:"x-axios-cache-etag",XAxiosCacheLastModified:"x-axios-cache-last-modified",XAxiosCacheStaleIfError:"x-axios-cache-stale-if-error"}),n=e=>{if(!e)return"not enough headers";const t=e[r.CacheControl];if(t){const{noCache:n,noStore:o,mustRevalidate:i,maxAge:s,immutable:d}=(0,a.parse)(String(t));if(n||o)return"dont cache";if(d)return 31536e6;if(i)return 0;if(void 0!==s){const t=e[r.Age];return t?1e3*(s-Number(t)):1e3*s}}const n=e[r.Expires];if(n){const e=Date.parse(String(n))-Date.now();return e>=0?e:"dont cache"}return"not enough headers"},o=require("fast-defer");function i(e){return e?t=>e(t)||304===t:e=>e>=200&&e<300||304===e}function s(e="get",t=[]){return e=e.toLowerCase(),t.some((t=>t===e))}function d(e,t){var a;t.headers||(t.headers={});const{etag:n,modifiedSince:o}=t.cache;if(n){const o=!0===n?null===(a=e.data)||void 0===a?void 0:a.headers[r.ETag]:n;o&&(t.headers[r.IfNoneMatch]=o)}o&&(t.headers[r.IfModifiedSince]=!0===o?e.data.headers[r.LastModified]||new Date(e.createdAt).toUTCString():o.toUTCString())}function c(e,t){return 304===e.status&&t?(e.cached=!0,e.data=t.data,e.status=t.status,e.statusText=t.statusText,e.headers=Object.assign(Object.assign({},t.headers),e.headers),t):{data:e.data,status:e.status,statusText:e.statusText,headers:e.headers}}function u(e){const t=async t=>{var a,n,c,u,l,g,f,h,p,m,v,b,w,y,S,I,x,C;const A=t.id=e.generateKey(t);if(!1===t.cache)return null===(a=e.debug)||void 0===a||a.call(e,{msg:"Ignoring cache because config.cache === false",data:t}),t;if(t.cache=Object.assign(Object.assign({},e.defaults.cache),t.cache),t.cache.cacheTakeover&&(null!==(n=t.headers)&&void 0!==n||(t.headers={}),null!==(c=(w=t.headers)[y=r.CacheControl])&&void 0!==c||(w[y]="no-cache"),null!==(u=(S=t.headers)[I=r.Pragma])&&void 0!==u||(S[I]="no-cache"),null!==(l=(x=t.headers)[C=r.Expires])&&void 0!==l||(x[C]="0")),!s(t.method,t.cache.methods))return null===(g=e.debug)||void 0===g||g.call(e,{msg:`Ignored because method (${t.method}) is not in cache.methods (${t.cache.methods})`}),t;let j=await e.storage.get(A,t);const E=t.cache.override;e:if("empty"===j.state||"stale"===j.state||E){if(e.waiting[A]&&!E&&(j=await e.storage.get(A,t),"empty"!==j.state)){null===(f=e.debug)||void 0===f||f.call(e,{id:A,msg:"Waiting list had an deferred for this key, waiting for it to finish"});break e}return e.waiting[A]=(0,o.deferred)(),e.waiting[A].catch((()=>{})),await e.storage.set(A,{state:"loading",previous:E?j.data?"stale":"empty":j.state,data:j.data,createdAt:E&&!j.createdAt?Date.now():j.createdAt},t),"stale"===j.state&&(d(j,t),null===(h=e.debug)||void 0===h||h.call(e,{id:A,msg:"Updated stale request"})),t.validateStatus=i(t.validateStatus),null===(p=e.debug)||void 0===p||p.call(e,{id:A,msg:"Sending request, waiting for response",data:{overrideCache:E,state:j.state}}),t}let O;if("loading"===j.state){const a=e.waiting[A];if(!a)return await e.storage.remove(A,t),t;null===(m=e.debug)||void 0===m||m.call(e,{id:A,msg:"Detected concurrent request, waiting for it to finish"});try{O=await a}catch(a){return null===(v=e.debug)||void 0===v||v.call(e,{id:A,msg:"Deferred rejected, requesting again",data:a}),t}}else O=j.data;return t.adapter=()=>Promise.resolve({config:t,data:O.data,headers:O.headers,status:O.status,statusText:O.statusText,cached:!0,id:A}),null===(b=e.debug)||void 0===b||b.call(e,{id:A,msg:"Returning cached response"}),t};return{onFulfilled:t,apply:()=>e.interceptors.request.use(t)}}async function l(e,t){var a;if("function"==typeof t)return t(e);const{statusCheck:r,responseMatch:n,containsHeaders:o}=t;if(r&&!await r(e.status)||n&&!await n(e))return!1;if(o)for(const[t,r]of Object.entries(o))if(!await r(null!==(a=e.headers[t.toLowerCase()])&&void 0!==a?a:e.headers[t]))return!1;return!0}async function g(e,t,a){if("function"==typeof a)return a(t);for(const[r,n]of Object.entries(a)){if("delete"===n){await e.remove(r,t.config);continue}const a=await e.get(r,t.config);if("loading"===a.state)continue;const o=await n(a,t);"delete"!==o?"ignore"!==o&&await e.set(r,o,t.config):await e.remove(r,t.config)}}function f(e){const t=async(t,a)=>{var r;await e.storage.remove(t,a),null===(r=e.waiting[t])||void 0===r||r.reject(),delete e.waiting[t]},a=async a=>{var n,o,i,s,d,u,f,h,p,m,v;const b=a.id=null!==(n=(v=a.config).id)&&void 0!==n?n:v.id=e.generateKey(a.config);if(null!==(o=a.cached)&&void 0!==o||(a.cached=!1),a.cached)return null===(i=e.debug)||void 0===i||i.call(e,{id:b,msg:"Returned cached response"}),a;const w=a.config.cache;if(!w)return null===(s=e.debug)||void 0===s||s.call(e,{id:b,msg:"Response with config.cache falsy",data:a}),Object.assign(Object.assign({},a),{cached:!1});const y=a.config,S=await e.storage.get(b,y);if((null==w?void 0:w.update)&&await g(e.storage,a,w.update),"loading"!==S.state)return null===(d=e.debug)||void 0===d||d.call(e,{id:b,msg:"Response not cached and storage isn't loading",data:{cache:S,response:a}}),a;if(!S.data&&!await l(a,w.cachePredicate))return await t(b,y),null===(u=e.debug)||void 0===u||u.call(e,{id:b,msg:"Cache predicate rejected this response"}),a;for(const e of Object.keys(a.headers))e.startsWith("x-axios-cache")&&delete a.headers[e];w.etag&&!0!==w.etag&&(a.headers[r.XAxiosCacheEtag]=w.etag),w.modifiedSince&&(a.headers[r.XAxiosCacheLastModified]=!0===w.modifiedSince?"use-cache-timestamp":w.modifiedSince.toUTCString());let I=w.ttl||-1;if(null==w?void 0:w.interpretHeader){const r=e.headerInterpreter(a.headers);if("dont cache"===r)return await t(b,y),null===(f=e.debug)||void 0===f||f.call(e,{id:b,msg:"Cache header interpreted as 'dont cache'",data:{cache:S,response:a,expirationTime:r}}),a;I="not enough headers"===r?I:r}const x=c(a,S.data);"function"==typeof I&&(I=await I(a)),w.staleIfError&&(a.headers[r.XAxiosCacheStaleIfError]=String(I)),null===(h=e.debug)||void 0===h||h.call(e,{id:b,msg:"Useful response configuration found",data:{cacheConfig:w,cacheResponse:x}});const C={state:"cached",ttl:I,createdAt:Date.now(),data:x},A=e.waiting[b];return A&&(A.resolve(C.data),delete e.waiting[b],null===(p=e.debug)||void 0===p||p.call(e,{id:b,msg:"Found waiting deferred(s) and resolved them"})),await e.storage.set(b,C,y),null===(m=e.debug)||void 0===m||m.call(e,{id:b,msg:"Response cached",data:{cache:C,response:a}}),a},n=async a=>{var r,n,o,i,s,d;const c=a.config;if(!(null==c?void 0:c.cache)||!c.id)throw null===(r=e.debug)||void 0===r||r.call(e,{msg:"Web request returned an error but cache handling is not enabled",data:{error:a}}),a;const u=await e.storage.get(c.id,c),l=c.cache;if("loading"!==u.state||"stale"!==u.previous)throw await t(c.id,c),null===(n=e.debug)||void 0===n||n.call(e,{msg:"Caught an error in the request interceptor",data:{error:a,config:c}}),a;if(null==l?void 0:l.staleIfError){const t="function"==typeof l.staleIfError?await l.staleIfError(a.response,u,a):l.staleIfError;if(null===(o=e.debug)||void 0===o||o.call(e,{msg:"Found cache if stale config for rejected response",data:{error:a,config:c,staleIfError:t}}),!0===t||"number"==typeof t&&u.createdAt+t>Date.now())return null===(i=e.waiting[c.id])||void 0===i||i.resolve(u.data),delete e.waiting[c.id],await e.storage.set(c.id,{state:"stale",createdAt:Date.now(),data:u.data},c),null===(s=e.debug)||void 0===s||s.call(e,{msg:"staleIfError resolved this response with cached data",data:{error:a,config:c,cache:u}}),{cached:!0,config:c,id:c.id,data:u.data.data,headers:u.data.headers,status:u.data.status,statusText:u.data.statusText}}throw null===(d=e.debug)||void 0===d||d.call(e,{msg:"Received an unknown error that could not be handled",data:{error:a,config:c}}),a};return{onFulfilled:a,onRejected:n,apply:()=>e.interceptors.response.use(a,n)}}const h=e=>!!e&&!!e["is-storage"];function p(e){const t=e.data.headers;return r.ETag in t||r.LastModified in t||r.XAxiosCacheEtag in t||r.XAxiosCacheStaleIfError in t||r.XAxiosCacheLastModified in t}function m(e){return e.createdAt+e.ttl<=Date.now()}function v({set:e,find:t,remove:a}){return{"is-storage":1,set:e,remove:a,get:async(r,n)=>{const o=await t(r,n);if(!o)return{state:"empty"};if("cached"!==o.state||!m(o))return o;if(p(o)){const t={state:"stale",createdAt:o.createdAt,data:o.data};return await e(r,t,n),t}return await a(r,n),{state:"empty"}}}}function b(e=!1){const t=v({set:(e,a)=>{t.data[e]=a},remove:e=>{delete t.data[e]},find:a=>{const r=t.data[a];return e&&void 0!==r?"function"==typeof structuredClone?structuredClone(r):JSON.parse(JSON.stringify(r)):r}});return t.data=Object.create(null),t}const w=require("object-code"),y=/^\/|\/$/g;function S(e){return t=>{if(t.id)return t.id;const a=e(t);return"string"==typeof a||"number"==typeof a?`${a}`:`${(0,w.hash)(a)}`}}const I=S((({baseURL:e="",url:t="",method:a="get",params:r,data:n})=>(e&&(e=e.replace(y,"")),t&&(t=t.replace(y,"")),a&&(a=a.toLowerCase()),{url:e+(e&&t?"/":"")+t,params:r,method:a,data:n})));function x(e,t={}){var a,r,o,i,s,d;const c=e;if(c.storage=t.storage||b(),!h(c.storage))throw new Error("Use buildStorage() function");return c.waiting=t.waiting||{},c.generateKey=t.generateKey||I,c.headerInterpreter=t.headerInterpreter||n,c.requestInterceptor=t.requestInterceptor||u(c),c.responseInterceptor=t.responseInterceptor||f(c),c.debug=t.debug,c.defaults.cache={update:t.update||{},ttl:null!==(a=t.ttl)&&void 0!==a?a:3e5,methods:t.methods||["get"],cachePredicate:t.cachePredicate||{statusCheck:e=>e>=200&&e<400},etag:null===(r=t.etag)||void 0===r||r,modifiedSince:null!==(o=t.modifiedSince)&&void 0!==o?o:!1===t.etag,interpretHeader:null===(i=t.interpretHeader)||void 0===i||i,cacheTakeover:null===(s=t.cacheTakeover)||void 0===s||s,staleIfError:null===(d=t.staleIfError)||void 0===d||d,override:!1},c.requestInterceptor.apply(),c.responseInterceptor.apply(),c}function C(e,t="axios-cache-"){return v({find:a=>{const r=e.getItem(t+a);return r?JSON.parse(r):void 0},remove:a=>{e.removeItem(t+a)},set:(a,r)=>{const n=()=>e.setItem(t+a,JSON.stringify(r));try{return n()}catch(r){const o=Object.entries(e).filter((e=>e[0].startsWith(t))).map((e=>[e[0],JSON.parse(e[1])]));for(const t of o)"cached"===t[1].state&&m(t[1])&&!p(t[1])&&e.removeItem(t[0]);try{return n()}catch(t){const a=o.sort(((e,t)=>(e[1].createdAt||0)-(t[1].createdAt||0)));for(const t of a){e.removeItem(t[0]);try{return n()}catch(e){}}}e.removeItem(t+a)}}})}console.error("You are using a development build. Make sure to use the correct build in production\nhttps://axios-cache-interceptor.js.org/#/pages/installing\n\n"),module.exports=t})();
//# sourceMappingURL=index.cjs.map