!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AxiosCacheInterceptor=t():e.AxiosCacheInterceptor=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Header:()=>s,buildKeyGenerator:()=>O,buildMemoryStorage:()=>C,buildStorage:()=>x,buildWebStorage:()=>R,canStale:()=>w,createCacheResponse:()=>h,createValidateStatus:()=>u,defaultHeaderInterpreter:()=>d,defaultKeyGenerator:()=>T,defaultRequestInterceptor:()=>g,defaultResponseInterceptor:()=>v,isExpired:()=>S,isMethodIn:()=>l,isStorage:()=>b,setupCache:()=>E,testCachePredicate:()=>p,updateCache:()=>m,updateStaleRequest:()=>f});var a=Symbol("cache-parser");function r(e){return("string"==typeof e||"number"==typeof e)&&(e=Number(e))>=0&&e<1/0}function o(e){return!0===e||"number"==typeof e||"string"==typeof e&&"false"!==e}var n=Number;function i(e){var t=Object.defineProperty({},a,{enumerable:!1,value:1});if(!e||"string"!=typeof e)return t;var i=function(e){var t={},a=e.toLowerCase().replace(/\s+/g,"").split(",");for(var r in a){var o,n=a[r].split("=",2);t[n[0]]=null==(o=n[1])||o}return t}(e),s=i["max-age"],d=i["max-stale"],c=i["min-fresh"],u=i["s-maxage"],l=i["stale-if-error"],f=i["stale-while-revalidate"];return o(i.immutable)&&(t.immutable=!0),r(s)&&(t.maxAge=n(s)),r(d)&&(t.maxStale=n(d)),r(c)&&(t.minFresh=n(c)),o(i["must-revalidate"])&&(t.mustRevalidate=!0),o(i["must-understand"])&&(t.mustUnderstand=!0),o(i["no-cache"])&&(t.noCache=!0),o(i["no-store"])&&(t.noStore=!0),o(i["no-transform"])&&(t.noTransform=!0),o(i["only-if-cached"])&&(t.onlyIfCached=!0),o(i.private)&&(t.private=!0),o(i["proxy-revalidate"])&&(t.proxyRevalidate=!0),o(i.public)&&(t.public=!0),r(u)&&(t.sMaxAge=n(u)),r(l)&&(t.staleIfError=n(l)),r(f)&&(t.staleWhileRevalidate=n(f)),t}const s=Object.freeze({IfModifiedSince:"if-modified-since",LastModified:"last-modified",IfNoneMatch:"if-none-match",CacheControl:"cache-control",Pragma:"pragma",ETag:"etag",Expires:"expires",Age:"age",XAxiosCacheEtag:"x-axios-cache-etag",XAxiosCacheLastModified:"x-axios-cache-last-modified",XAxiosCacheStaleIfError:"x-axios-cache-stale-if-error"}),d=e=>{if(!e)return"not enough headers";const t=e[s.CacheControl];if(t){const{noCache:a,noStore:r,maxAge:o,maxStale:n,immutable:d,staleWhileRevalidate:c}=i(String(t));if(a||r)return"dont cache";if(d)return{cache:31536e6};if(void 0!==o){const t=e[s.Age];return{cache:t?1e3*(o-Number(t)):1e3*o,stale:void 0!==n?1e3*n:void 0!==c?1e3*c:void 0}}}const a=e[s.Expires];if(a){const e=Date.parse(String(a))-Date.now();return e>=0?{cache:e}:"dont cache"}return"not enough headers"};var c=Symbol();function u(e){return e?t=>e(t)||304===t:e=>e>=200&&e<300||304===e}function l(e="get",t=[]){return e=e.toLowerCase(),t.some((t=>t===e))}function f(e,t){var a;t.headers||(t.headers={});const{etag:r,modifiedSince:o}=t.cache;if(r){const o=!0===r?null===(a=e.data)||void 0===a?void 0:a.headers[s.ETag]:r;o&&(t.headers[s.IfNoneMatch]=o)}o&&(t.headers[s.IfModifiedSince]=!0===o?e.data.headers[s.LastModified]||new Date(e.createdAt).toUTCString():o.toUTCString())}function h(e,t){return 304===e.status&&t?(e.cached=!0,e.data=t.data,e.status=t.status,e.statusText=t.statusText,e.headers=Object.assign(Object.assign({},t.headers),e.headers),t):{data:e.data,status:e.status,statusText:e.statusText,headers:e.headers}}function g(e){const t=async a=>{var r,o,n,i,d,h,g,p,m,v,b,y,w,S,x;if(a.id=e.generateKey(a),!1===a.cache)return e.debug({msg:"Ignoring cache because config.cache === false",data:a}),a;if(a.cache=Object.assign(Object.assign({},e.defaults.cache),a.cache),a.cache.cacheTakeover&&(null!==(r=(v=a.headers)[b=s.CacheControl])&&void 0!==r||(v[b]="no-cache"),null!==(o=(y=a.headers)[w=s.Pragma])&&void 0!==o||(y[w]="no-cache"),null!==(n=(S=a.headers)[x=s.Expires])&&void 0!==n||(S[x]="0")),!l(a.method,a.cache.methods))return e.debug({msg:`Ignored because method (${a.method}) is not in cache.methods (${a.cache.methods})`}),a;let C=await e.storage.get(a.id,a);const I=a.cache.override;e:if("empty"===C.state||"stale"===C.state||I){if(e.waiting[a.id]&&!I&&(C=await e.storage.get(a.id,a),"empty"!==C.state)){e.debug({id:a.id,msg:"Waiting list had an deferred for this key, waiting for it to finish"});break e}return e.waiting[a.id]=function(){var e,t,a=new Promise((function(a,r){e=a,t=r}));return a.resolve=e,a.reject=t,a[c]=1,a}(),e.waiting[a.id].catch((()=>{})),await e.storage.set(a.id,{state:"loading",previous:I?C.data?"stale":"empty":C.state,data:C.data,createdAt:I&&!C.createdAt?Date.now():C.createdAt},a),"stale"===C.state&&(f(C,a),e.debug({id:a.id,msg:"Updated stale request"})),a.validateStatus=u(a.validateStatus),e.debug({id:a.id,msg:"Sending request, waiting for response",data:{overrideCache:I,state:C.state}}),("stale"===C.state||C.data)&&await(null===(d=(i=a.cache).hydrate)||void 0===d?void 0:d.call(i,C)),a}let j;if("loading"===C.state){const r=e.waiting[a.id];if(!r)return C.data&&await(null===(g=(h=a.cache).hydrate)||void 0===g?void 0:g.call(h,C)),a;e.debug({id:a.id,msg:"Detected concurrent request, waiting for it to finish"});try{j=await r}catch(r){return e.debug({id:a.id,msg:"Deferred rejected, requesting again",data:r}),C.data&&await(null===(m=(p=a.cache).hydrate)||void 0===m?void 0:m.call(p,C)),t(a)}}else j=C.data;return a.adapter=function(){return Promise.resolve({config:a,data:j.data,headers:j.headers,status:j.status,statusText:j.statusText,cached:!0,id:a.id})},e.debug({id:a.id,msg:"Returning cached response"}),a};return{onFulfilled:t,apply:()=>e.interceptors.request.use(t)}}async function p(e,t){var a;if("function"==typeof t)return t(e);const{statusCheck:r,responseMatch:o,containsHeaders:n}=t;if(r&&!await r(e.status)||o&&!await o(e))return!1;if(n)for(const[t,r]of Object.entries(n))if(!await r(null!==(a=e.headers[t.toLowerCase()])&&void 0!==a?a:e.headers[t]))return!1;return!0}async function m(e,t,a){if("function"==typeof a)return a(t);for(const[r,o]of Object.entries(a)){if("delete"===o){await e.remove(r,t.config);continue}const a=await e.get(r,t.config);if("loading"===a.state)continue;const n=await o(a,t);"delete"!==n?"ignore"!==n&&await e.set(r,n,t.config):await e.remove(r,t.config)}}function v(e){const t=async(t,a)=>{var r;await e.storage.remove(t,a),null===(r=e.waiting[t])||void 0===r||r.reject(),delete e.waiting[t]},a=async a=>{var r;if(!(null==a?void 0:a.config))throw e.debug({msg:"Response interceptor received an unknown response.",data:a}),a;a.id=a.config.id,null!==(r=a.cached)&&void 0!==r||(a.cached=!1);const o=a.config,n=o.cache;if(a.cached)return e.debug({id:a.id,msg:"Returned cached response"}),a;if(!n)return e.debug({id:a.id,msg:"Response with config.cache falsy",data:a}),a.cached=!1,a;if(n.update&&await m(e.storage,a,n.update),!l(o.method,n.methods))return e.debug({id:a.id,msg:`Ignored because method (${o.method}) is not in cache.methods (${n.methods})`,data:{config:o,cacheConfig:n}}),a;const i=await e.storage.get(a.id,o);if("loading"!==i.state)return e.debug({id:a.id,msg:"Response not cached and storage isn't loading",data:{cache:i,response:a}}),a;if(!i.data&&!await p(a,n.cachePredicate))return await t(a.id,o),e.debug({id:a.id,msg:"Cache predicate rejected this response"}),a;for(const e of Object.keys(a.headers))e.startsWith("x-axios-cache")&&delete a.headers[e];n.etag&&!0!==n.etag&&(a.headers[s.XAxiosCacheEtag]=n.etag),n.modifiedSince&&(a.headers[s.XAxiosCacheLastModified]=!0===n.modifiedSince?"use-cache-timestamp":n.modifiedSince.toUTCString());let d,c=n.ttl||-1;if(n.interpretHeader){const r=e.headerInterpreter(a.headers);if("dont cache"===r)return await t(a.id,o),e.debug({id:a.id,msg:"Cache header interpreted as 'dont cache'",data:{cache:i,response:a,expirationTime:r}}),a;"not enough headers"!==r&&("number"==typeof r?c=r:(c=r.cache,d=r.stale))}const u=h(a,i.data);"function"==typeof c&&(c=await c(a)),n.staleIfError&&(a.headers[s.XAxiosCacheStaleIfError]=String(c)),e.debug({id:a.id,msg:"Useful response configuration found",data:{cacheConfig:n,cacheResponse:u}});const f={state:"cached",ttl:c,staleTtl:d,createdAt:Date.now(),data:u},g=e.waiting[a.id];return g&&(g.resolve(f.data),delete e.waiting[a.id],e.debug({id:a.id,msg:"Found waiting deferred(s) and resolved them"})),await e.storage.set(a.id,f,o),e.debug({id:a.id,msg:"Response cached",data:{cache:f,response:a}}),a},r=async a=>{var r;if(!a.isAxiosError||!a.config)throw e.debug({msg:"FATAL: Received an non axios error in the rejected response interceptor, ignoring.",data:a}),a;const o=a.config,n=o.id,d=o.cache,c=a.response;if(!d||!n)throw e.debug({msg:"Web request returned an error but cache handling is not enabled",data:{error:a}}),a;if(!l(o.method,d.methods))throw e.debug({id:n,msg:`Ignored because method (${o.method}) is not in cache.methods (${d.methods})`,data:{config:o,cacheConfig:d}}),await t(n,o),a;const u=await e.storage.get(n,o);if("loading"!==u.state||"stale"!==u.previous)throw e.debug({id:n,msg:"Caught an error in the request interceptor",data:{cache:u,error:a,config:o}}),await t(n,o),a;if(d.staleIfError){const t=String(null==c?void 0:c.headers[s.CacheControl]),l=t&&i(t).staleIfError,f="function"==typeof d.staleIfError?await d.staleIfError(c,u,a):!0===d.staleIfError&&l?1e3*l:d.staleIfError;if(e.debug({id:n,msg:"Found cache if stale config for rejected response",data:{error:a,config:o,staleIfError:f}}),!0===f||"number"==typeof f&&u.createdAt+f>Date.now())return null===(r=e.waiting[n])||void 0===r||r.resolve(u.data),delete e.waiting[n],await e.storage.set(n,{state:"stale",createdAt:Date.now(),data:u.data},o),e.debug({id:n,msg:"staleIfError resolved this response with cached data",data:{error:a,config:o,cache:u}}),{cached:!0,config:o,id:n,data:u.data.data,headers:u.data.headers,status:u.data.status,statusText:u.data.statusText}}throw e.debug({id:n,msg:"Received an unknown error that could not be handled",data:{error:a,config:o}}),await t(n,o),a};return{onFulfilled:a,onRejected:r,apply:()=>e.interceptors.response.use(a,r)}}const b=e=>!!e&&!!e["is-storage"];function y(e){const t=e.data.headers;return s.ETag in t||s.LastModified in t||s.XAxiosCacheEtag in t||s.XAxiosCacheLastModified in t}function w(e){return!String(e.data.headers[s.CacheControl]).includes("must-revalidate")&&(!!y(e)||"cached"===e.state&&void 0!==e.staleTtl&&Math.abs(Date.now()-(e.createdAt+e.ttl))<=e.staleTtl)}function S(e){return void 0!==e.ttl&&e.createdAt+e.ttl<=Date.now()}function x({set:e,find:t,remove:a}){return{"is-storage":1,set:e,remove:a,get:async(r,o)=>{let n=await t(r,o);if(!n)return{state:"empty"};if("empty"===n.state||"loading"===n.state)return n;if("cached"===n.state){if(!S(n))return n;if(!w(n))return await a(r,o),{state:"empty"};n={state:"stale",createdAt:n.createdAt,data:n.data,ttl:void 0!==n.staleTtl?n.staleTtl+n.ttl:void 0},await e(r,n,o)}return S(n)?y(n)?n:(await a(r,o),{state:"empty"}):n}}}function C(e=!1,t=!1,a=!1){const r=x({set:(t,o)=>{if(a){let e=Object.keys(r.data);if(e.length>=a)for(r.cleanup(),e=Object.keys(r.data);e.length>=a;)delete r.data[e.shift()]}r.data[t]="double"===e?"function"==typeof structuredClone?structuredClone(o):JSON.parse(JSON.stringify(o)):o},remove:e=>{delete r.data[e]},find:t=>{const a=r.data[t];return e&&void 0!==a?"function"==typeof structuredClone?structuredClone(a):JSON.parse(JSON.stringify(a)):a}});return r.data=Object.create(null),r.cleanup=()=>{const e=Object.keys(r.data);let t,a,o=-1;for(;++o<e.length;)a=e[o],t=r.data[a],"empty"!==t.state?"cached"===t.state&&S(t)&&!w(t)&&r.remove(a):r.remove(a)},t&&(r.cleaner=setInterval(r.cleanup,t)),r}function I(e,t){return e>t?1:-1}function j(e,t){var a=5381;if("object"==typeof e&&null!==e&&(e.toString===Object.prototype.toString||e.toString===Array.prototype.toString)){t||(t=new WeakSet);for(var r=Object.keys(e).sort(I),o=0;o<r.length;o++){var n=r[o],i=e[n];if(a=33*a^j(n,t),"object"==typeof i&&null!==i&&(e.toString===Object.prototype.toString||e.toString===Array.prototype.toString)){if(t.has(i))continue;t.add(i)}a=33*a^j(i,t)}return 33*a^j(e.constructor,t)}var s=typeof e;try{e instanceof Date?s+=e.getTime():s+=String(e)}catch(t){s+=String(Object.assign({},e))}for(var d=0;d<s.length;d++)a=33*a^s.charCodeAt(d);return a}const A=/^\/|\/$/g;function O(e){return t=>{if(t.id)return t.id;const a=e(t);return"string"==typeof a||"number"==typeof a?`${a}`:`${j(a)}`}}const T=O((({baseURL:e,url:t,method:a,params:r,data:o})=>(e=void 0!==e?e.replace(A,""):"",t=void 0!==t?t.replace(A,""):"",{url:e+(e&&t?"/":"")+t,params:r,method:a=void 0!==a?a.toLowerCase():"get",data:o})));function E(e,t={}){var a,r,o,n,i,s,c,u;const l=e;if(l.defaults.cache)throw new Error("setupCache() should be called only once");if(l.storage=t.storage||C(),!b(l.storage))throw new Error("Use buildStorage() function");return l.waiting=t.waiting||{},l.generateKey=t.generateKey||T,l.headerInterpreter=t.headerInterpreter||d,l.requestInterceptor=t.requestInterceptor||g(l),l.responseInterceptor=t.responseInterceptor||v(l),l.debug=t.debug||function(){},l.defaults.cache={update:t.update||{},ttl:null!==(a=t.ttl)&&void 0!==a?a:3e5,methods:t.methods||["get","head"],cachePredicate:t.cachePredicate||{statusCheck:e=>[200,203,300,301,302,404,405,410,414,501].includes(e)},etag:null===(r=t.etag)||void 0===r||r,modifiedSince:null!==(o=t.modifiedSince)&&void 0!==o?o:!1===t.etag,interpretHeader:null===(n=t.interpretHeader)||void 0===n||n,cacheTakeover:null===(i=t.cacheTakeover)||void 0===i||i,staleIfError:null===(s=t.staleIfError)||void 0===s||s,override:null!==(c=t.override)&&void 0!==c&&c,hydrate:null!==(u=t.hydrate)&&void 0!==u?u:void 0},l.requestInterceptor.apply(),l.responseInterceptor.apply(),l}function R(e,t="axios-cache-"){return x({find:a=>{const r=e.getItem(t+a);return r?JSON.parse(r):void 0},remove:a=>{e.removeItem(t+a)},set:(a,r)=>{const o=()=>e.setItem(t+a,JSON.stringify(r));try{return o()}catch(r){const n=Object.entries(e).filter((e=>e[0].startsWith(t))).map((e=>[e[0],JSON.parse(e[1])]));for(const t of n)"cached"===t[1].state&&S(t[1])&&!w(t[1])&&e.removeItem(t[0]);try{return o()}catch(t){const a=n.sort(((e,t)=>(e[1].createdAt||0)-(t[1].createdAt||0)));for(const t of a){e.removeItem(t[0]);try{return o()}catch(e){}}}e.removeItem(t+a)}}})}return console.error("You are using a development build. Make sure to use the correct build in production\nhttps://axios-cache-interceptor.js.org/guide/getting-started\n\n"),t})()));
//# sourceMappingURL=index.bundle.js.map