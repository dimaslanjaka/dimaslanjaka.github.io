!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AxiosCacheInterceptor=t():e.AxiosCacheInterceptor=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Header:()=>s,buildKeyGenerator:()=>O,buildMemoryStorage:()=>C,buildStorage:()=>S,buildWebStorage:()=>R,canStale:()=>w,createCacheResponse:()=>h,createValidateStatus:()=>l,defaultHeaderInterpreter:()=>c,defaultKeyGenerator:()=>E,defaultRequestInterceptor:()=>g,defaultResponseInterceptor:()=>v,isExpired:()=>x,isMethodIn:()=>u,isStorage:()=>b,setupCache:()=>T,testCachePredicate:()=>p,updateCache:()=>m,updateStaleRequest:()=>f});var a=Symbol("cache-parser");function r(e){return("string"==typeof e||"number"==typeof e)&&(e=Number(e))>=0&&e<1/0}function n(e){return!0===e||"number"==typeof e||"string"==typeof e&&"false"!==e}var o=Number;function i(e){var t=Object.defineProperty({},a,{enumerable:!1,value:1});if(!e||"string"!=typeof e)return t;var i=function(e){var t={},a=e.toLowerCase().replace(/\s+/g,"").split(",");for(var r in a){var n,o=a[r].split("=",2);t[o[0]]=null==(n=o[1])||n}return t}(e),s=i["max-age"],c=i["max-stale"],d=i["min-fresh"],l=i["s-maxage"],u=i["stale-if-error"],f=i["stale-while-revalidate"];return n(i.immutable)&&(t.immutable=!0),r(s)&&(t.maxAge=o(s)),r(c)&&(t.maxStale=o(c)),r(d)&&(t.minFresh=o(d)),n(i["must-revalidate"])&&(t.mustRevalidate=!0),n(i["must-understand"])&&(t.mustUnderstand=!0),n(i["no-cache"])&&(t.noCache=!0),n(i["no-store"])&&(t.noStore=!0),n(i["no-transform"])&&(t.noTransform=!0),n(i["only-if-cached"])&&(t.onlyIfCached=!0),n(i.private)&&(t.private=!0),n(i["proxy-revalidate"])&&(t.proxyRevalidate=!0),n(i.public)&&(t.public=!0),r(l)&&(t.sMaxAge=o(l)),r(u)&&(t.staleIfError=o(u)),r(f)&&(t.staleWhileRevalidate=o(f)),t}const s=Object.freeze({IfModifiedSince:"if-modified-since",LastModified:"last-modified",IfNoneMatch:"if-none-match",CacheControl:"cache-control",Pragma:"pragma",ETag:"etag",Expires:"expires",Age:"age",XAxiosCacheEtag:"x-axios-cache-etag",XAxiosCacheLastModified:"x-axios-cache-last-modified",XAxiosCacheStaleIfError:"x-axios-cache-stale-if-error"}),c=e=>{if(!e)return"not enough headers";const t=e[s.CacheControl];if(t){const{noCache:a,noStore:r,maxAge:n,maxStale:o,immutable:c,staleWhileRevalidate:d}=i(String(t));if(a||r)return"dont cache";if(c)return{cache:31536e6};if(void 0!==n){const t=e[s.Age];return{cache:t?1e3*(n-Number(t)):1e3*n,stale:void 0!==o?1e3*o:void 0!==d?1e3*d:void 0}}}const a=e[s.Expires];if(a){const e=Date.parse(String(a))-Date.now();return e>=0?{cache:e}:"dont cache"}return"not enough headers"};var d=Symbol();function l(e){return e?t=>e(t)||304===t:e=>e>=200&&e<300||304===e}function u(e="get",t=[]){return e=e.toLowerCase(),t.some((t=>t===e))}function f(e,t){var a;t.headers||(t.headers={});const{etag:r,modifiedSince:n}=t.cache;if(r){const n=!0===r?null===(a=e.data)||void 0===a?void 0:a.headers[s.ETag]:r;n&&(t.headers[s.IfNoneMatch]=n)}n&&(t.headers[s.IfModifiedSince]=!0===n?e.data.headers[s.LastModified]||new Date(e.createdAt).toUTCString():n.toUTCString())}function h(e,t){return 304===e.status&&t?(e.cached=!0,e.data=t.data,e.status=t.status,e.statusText=t.statusText,e.headers=Object.assign(Object.assign({},t.headers),e.headers),t):{data:e.data,status:e.status,statusText:e.statusText,headers:e.headers}}function g(e){const t=async t=>{var a,r,n,o,i,c,h,g,p,m,v,b,y,w,x,S,C,I,j,A,O,E,T;const R=t.id=e.generateKey(t);if(!1===t.cache)return null===(a=e.debug)||void 0===a||a.call(e,{msg:"Ignoring cache because config.cache === false",data:t}),t;if(t.cache=Object.assign(Object.assign({},e.defaults.cache),t.cache),t.cache.cacheTakeover&&(null!==(r=(I=t.headers)[j=s.CacheControl])&&void 0!==r||(I[j]="no-cache"),null!==(n=(A=t.headers)[O=s.Pragma])&&void 0!==n||(A[O]="no-cache"),null!==(o=(E=t.headers)[T=s.Expires])&&void 0!==o||(E[T]="0")),!u(t.method,t.cache.methods))return null===(i=e.debug)||void 0===i||i.call(e,{msg:`Ignored because method (${t.method}) is not in cache.methods (${t.cache.methods})`}),t;let M=await e.storage.get(R,t);const k=t.cache.override;e:if("empty"===M.state||"stale"===M.state||k){if(e.waiting[R]&&!k&&(M=await e.storage.get(R,t),"empty"!==M.state)){null===(c=e.debug)||void 0===c||c.call(e,{id:R,msg:"Waiting list had an deferred for this key, waiting for it to finish"});break e}return e.waiting[R]=function(){var e,t,a=new Promise((function(a,r){e=a,t=r}));return a.resolve=e,a.reject=t,a[d]=1,a}(),e.waiting[R].catch((()=>{})),await e.storage.set(R,{state:"loading",previous:k?M.data?"stale":"empty":M.state,data:M.data,createdAt:k&&!M.createdAt?Date.now():M.createdAt},t),"stale"===M.state&&(f(M,t),null===(h=e.debug)||void 0===h||h.call(e,{id:R,msg:"Updated stale request"})),t.validateStatus=l(t.validateStatus),null===(g=e.debug)||void 0===g||g.call(e,{id:R,msg:"Sending request, waiting for response",data:{overrideCache:k,state:M.state}}),("stale"===M.state||M.data)&&await(null===(m=(p=t.cache).hydrate)||void 0===m?void 0:m.call(p,M)),t}let P;if("loading"===M.state){const a=e.waiting[R];if(!a)return await e.storage.remove(R,t),M.data&&await(null===(b=(v=t.cache).hydrate)||void 0===b?void 0:b.call(v,M)),t;null===(y=e.debug)||void 0===y||y.call(e,{id:R,msg:"Detected concurrent request, waiting for it to finish"});try{P=await a}catch(a){return null===(w=e.debug)||void 0===w||w.call(e,{id:R,msg:"Deferred rejected, requesting again",data:a}),M.data&&await(null===(S=(x=t.cache).hydrate)||void 0===S?void 0:S.call(x,M)),t}}else P=M.data;return t.adapter=()=>Promise.resolve({config:t,data:P.data,headers:P.headers,status:P.status,statusText:P.statusText,cached:!0,id:R}),null===(C=e.debug)||void 0===C||C.call(e,{id:R,msg:"Returning cached response"}),t};return{onFulfilled:t,apply:()=>e.interceptors.request.use(t)}}async function p(e,t){var a;if("function"==typeof t)return t(e);const{statusCheck:r,responseMatch:n,containsHeaders:o}=t;if(r&&!await r(e.status)||n&&!await n(e))return!1;if(o)for(const[t,r]of Object.entries(o))if(!await r(null!==(a=e.headers[t.toLowerCase()])&&void 0!==a?a:e.headers[t]))return!1;return!0}async function m(e,t,a){if("function"==typeof a)return a(t);for(const[r,n]of Object.entries(a)){if("delete"===n){await e.remove(r,t.config);continue}const a=await e.get(r,t.config);if("loading"===a.state)continue;const o=await n(a,t);"delete"!==o?"ignore"!==o&&await e.set(r,o,t.config):await e.remove(r,t.config)}}function v(e){const t=async(t,a)=>{var r;await e.storage.remove(t,a),null===(r=e.waiting[t])||void 0===r||r.reject(),delete e.waiting[t]},a=async a=>{var r,n,o,i,c,d,l,f,g,v,b,y,w;if(!a.config)throw null===(r=e.debug)||void 0===r||r.call(e,{msg:"Response interceptor received an unknown response.",data:a}),a;const x=a.id=null!==(n=(w=a.config).id)&&void 0!==n?n:w.id=e.generateKey(a.config);if(null!==(o=a.cached)&&void 0!==o||(a.cached=!1),a.cached)return null===(i=e.debug)||void 0===i||i.call(e,{id:x,msg:"Returned cached response"}),a;const S=a.config,C=S.cache;if(!C)return null===(c=e.debug)||void 0===c||c.call(e,{id:x,msg:"Response with config.cache falsy",data:a}),Object.assign(Object.assign({},a),{cached:!1});if(C.update&&await m(e.storage,a,C.update),!u(S.method,C.methods))return null===(d=e.debug)||void 0===d||d.call(e,{id:x,msg:`Ignored because method (${S.method}) is not in cache.methods (${C.methods})`,data:{config:S,cacheConfig:C}}),a;const I=await e.storage.get(x,S);if("loading"!==I.state)return null===(l=e.debug)||void 0===l||l.call(e,{id:x,msg:"Response not cached and storage isn't loading",data:{cache:I,response:a}}),a;if(!I.data&&!await p(a,C.cachePredicate))return await t(x,S),null===(f=e.debug)||void 0===f||f.call(e,{id:x,msg:"Cache predicate rejected this response"}),a;for(const e of Object.keys(a.headers))e.startsWith("x-axios-cache")&&delete a.headers[e];C.etag&&!0!==C.etag&&(a.headers[s.XAxiosCacheEtag]=C.etag),C.modifiedSince&&(a.headers[s.XAxiosCacheLastModified]=!0===C.modifiedSince?"use-cache-timestamp":C.modifiedSince.toUTCString());let j,A=C.ttl||-1;if(C.interpretHeader){const r=e.headerInterpreter(a.headers);if("dont cache"===r)return await t(x,S),null===(g=e.debug)||void 0===g||g.call(e,{id:x,msg:"Cache header interpreted as 'dont cache'",data:{cache:I,response:a,expirationTime:r}}),a;"not enough headers"!==r&&("number"==typeof r?A=r:(A=r.cache,j=r.stale))}const O=h(a,I.data);"function"==typeof A&&(A=await A(a)),C.staleIfError&&(a.headers[s.XAxiosCacheStaleIfError]=String(A)),null===(v=e.debug)||void 0===v||v.call(e,{id:x,msg:"Useful response configuration found",data:{cacheConfig:C,cacheResponse:O}});const E={state:"cached",ttl:A,staleTtl:j,createdAt:Date.now(),data:O},T=e.waiting[x];return T&&(T.resolve(E.data),delete e.waiting[x],null===(b=e.debug)||void 0===b||b.call(e,{id:x,msg:"Found waiting deferred(s) and resolved them"})),await e.storage.set(x,E,S),null===(y=e.debug)||void 0===y||y.call(e,{id:x,msg:"Response cached",data:{cache:E,response:a}}),a},r=async a=>{var r,n,o,c,d,l,f;const h=a.config,g=h.id,p=h.cache,m=a.response;if(!p||!g)throw null===(r=e.debug)||void 0===r||r.call(e,{msg:"Web request returned an error but cache handling is not enabled",data:{error:a}}),a;if(!u(h.method,p.methods))throw null===(n=e.debug)||void 0===n||n.call(e,{id:g,msg:`Ignored because method (${h.method}) is not in cache.methods (${p.methods})`,data:{config:h,cacheConfig:p}}),a;const v=await e.storage.get(g,h);if("loading"!==v.state||"stale"!==v.previous)throw await t(g,h),null===(o=e.debug)||void 0===o||o.call(e,{id:g,msg:"Caught an error in the request interceptor",data:{cache:v,error:a,config:h}}),a;if(p.staleIfError){const t=String(null==m?void 0:m.headers[s.CacheControl]),r=t&&i(t).staleIfError,n="function"==typeof p.staleIfError?await p.staleIfError(m,v,a):!0===p.staleIfError&&r?1e3*r:p.staleIfError;if(null===(c=e.debug)||void 0===c||c.call(e,{id:g,msg:"Found cache if stale config for rejected response",data:{error:a,config:h,staleIfError:n}}),!0===n||"number"==typeof n&&v.createdAt+n>Date.now())return null===(d=e.waiting[g])||void 0===d||d.resolve(v.data),delete e.waiting[g],await e.storage.set(g,{state:"stale",createdAt:Date.now(),data:v.data},h),null===(l=e.debug)||void 0===l||l.call(e,{id:g,msg:"staleIfError resolved this response with cached data",data:{error:a,config:h,cache:v}}),{cached:!0,config:h,id:g,data:v.data.data,headers:v.data.headers,status:v.data.status,statusText:v.data.statusText}}throw null===(f=e.debug)||void 0===f||f.call(e,{id:g,msg:"Received an unknown error that could not be handled",data:{error:a,config:h}}),a};return{onFulfilled:a,onRejected:r,apply:()=>e.interceptors.response.use(a,r)}}const b=e=>!!e&&!!e["is-storage"];function y(e){const t=e.data.headers;return s.ETag in t||s.LastModified in t||s.XAxiosCacheEtag in t||s.XAxiosCacheLastModified in t}function w(e){return!String(e.data.headers[s.CacheControl]).includes("must-revalidate")&&(!!y(e)||"cached"===e.state&&void 0!==e.staleTtl&&Math.abs(Date.now()-(e.createdAt+e.ttl))<=e.staleTtl)}function x(e){return void 0!==e.ttl&&e.createdAt+e.ttl<=Date.now()}function S({set:e,find:t,remove:a}){return{"is-storage":1,set:e,remove:a,get:async(r,n)=>{let o=await t(r,n);if(!o)return{state:"empty"};if("empty"===o.state||"loading"===o.state)return o;if("cached"===o.state){if(!x(o))return o;if(!w(o))return await a(r,n),{state:"empty"};o={state:"stale",createdAt:o.createdAt,data:o.data,ttl:void 0!==o.staleTtl?o.staleTtl+o.ttl:void 0},await e(r,o,n)}return x(o)?y(o)?o:(await a(r,n),{state:"empty"}):o}}}function C(e=!1,t=!1,a=!1){const r=S({set:(e,t)=>{if(a){let e=Object.keys(r.data);if(e.length>=a)for(r.cleanup(),e=Object.keys(r.data);e.length>=a;)delete r.data[e.shift()]}r.data[e]=t},remove:e=>{delete r.data[e]},find:t=>{const a=r.data[t];return e&&void 0!==a?"function"==typeof structuredClone?structuredClone(a):JSON.parse(JSON.stringify(a)):a}});return r.data=Object.create(null),r.cleanup=()=>{const e=Object.keys(r.data);let t,a,n=-1;for(;++n<e.length;)a=e[n],t=r.data[a],"empty"!==t.state?"cached"===t.state&&x(t)&&!w(t)&&r.remove(a):r.remove(a)},t&&(r.cleaner=setInterval(r.cleanup,t)),r}function I(e){var t=typeof e;if(e&&"object"===t&&!(e instanceof Date||e instanceof RegExp)){for(var a=Array.isArray(e)?[]:{},r=Object.keys(e).sort((function(e,t){return e>t?1:-1})),n=r.length;n--;){var o=r[n];a[o]=I(e[o])}return String(e.constructor)+JSON.stringify(a,r)}return t+String(e)}function j(e){e=I(e);for(var t=5381,a=0;a<e.length;)t=33*t^e.charCodeAt(a++);return t}const A=/^\/|\/$/g;function O(e){return t=>{if(t.id)return t.id;const a=e(t);return"string"==typeof a||"number"==typeof a?`${a}`:`${j(a)}`}}const E=O((({baseURL:e="",url:t="",method:a="get",params:r,data:n})=>(e&&(e=e.replace(A,"")),t&&(t=t.replace(A,"")),a&&(a=a.toLowerCase()),{url:e+(e&&t?"/":"")+t,params:r,method:a,data:n})));function T(e,t={}){var a,r,n,o,i,s;const d=e;if(d.defaults.cache)throw new Error("setupCache() should be called only once");if(d.storage=t.storage||C(),!b(d.storage))throw new Error("Use buildStorage() function");return d.waiting=t.waiting||{},d.generateKey=t.generateKey||E,d.headerInterpreter=t.headerInterpreter||c,d.requestInterceptor=t.requestInterceptor||g(d),d.responseInterceptor=t.responseInterceptor||v(d),d.debug=t.debug,d.defaults.cache={update:t.update||{},ttl:null!==(a=t.ttl)&&void 0!==a?a:3e5,methods:t.methods||["get","head"],cachePredicate:t.cachePredicate||{statusCheck:e=>[200,203,300,301,302,404,405,410,414,501].includes(e)},etag:null===(r=t.etag)||void 0===r||r,modifiedSince:null!==(n=t.modifiedSince)&&void 0!==n?n:!1===t.etag,interpretHeader:null===(o=t.interpretHeader)||void 0===o||o,cacheTakeover:null===(i=t.cacheTakeover)||void 0===i||i,staleIfError:null===(s=t.staleIfError)||void 0===s||s,override:!1,hydrate:void 0},d.requestInterceptor.apply(),d.responseInterceptor.apply(),d}function R(e,t="axios-cache-"){return S({find:a=>{const r=e.getItem(t+a);return r?JSON.parse(r):void 0},remove:a=>{e.removeItem(t+a)},set:(a,r)=>{const n=()=>e.setItem(t+a,JSON.stringify(r));try{return n()}catch(r){const o=Object.entries(e).filter((e=>e[0].startsWith(t))).map((e=>[e[0],JSON.parse(e[1])]));for(const t of o)"cached"===t[1].state&&x(t[1])&&!w(t[1])&&e.removeItem(t[0]);try{return n()}catch(t){const a=o.sort(((e,t)=>(e[1].createdAt||0)-(t[1].createdAt||0)));for(const t of a){e.removeItem(t[0]);try{return n()}catch(e){}}}e.removeItem(t+a)}}})}return console.error("You are using a development build. Make sure to use the correct build in production\nhttps://axios-cache-interceptor.js.org/guide/getting-started\n\n"),t})()));
//# sourceMappingURL=index.bundle.js.map