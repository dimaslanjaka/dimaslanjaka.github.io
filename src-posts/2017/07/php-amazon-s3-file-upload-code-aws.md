---
author:
  nick: Unknown
  link: ""
  email: noreply@blogger.com
category: []
comments: true
cover: https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/2048px-No_image_available.svg.png
date: 2017-07-24T07:44:00.000+07:00
lang: en
location: ""
modified: 2017-07-24T07:44:02.718+07:00
subtitle: Amazon offers a PHP SDK for taking care of AWS and S asks for, yet it
  tips the scales at more than 500 documents and almost 5MB. In the
tags:
  - PHP
title: PHP Amazon S3 File Upload Code AWS Signature Version 4
type: post
uuid: b44a833c-625f-4888-881b-88122d881b86
webtitle: WMI Gitlab
updated: 2017-07-24T07:44:02+07:00
thumbnail: https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/2048px-No_image_available.svg.png
photos:
  - https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/2048px-No_image_available.svg.png
description: Amazon offers a PHP SDK for taking care of AWS and S asks for, yet
  it tips the scales at more than 500 documents and almost 5MB. In the
---

<span id="span_a5da_0">Amazon offers a PHP SDK for taking care of AWS and S3 asks for, yet it tips the scales at more than 500 documents and almost 5MB. In the event that you simply need to transfer a record to a S3 basin utilizing PHP, you can make the HTTP POST ask for yourself utilizing just around 50 lines of code. This is likewise helpful on the off chance that you need to see how the demand and approval prepare function.</span><br><br id="br_a5da_1"><b id="b_a5da_0">AWS Signature Version 4</b><br><span id="span_a5da_1">This code uses Amazon AWS Signature Version 4. To view the old Version 2 code, see&nbsp;</span><a href="https://www.h3xed.com/programming/simple-php-code-for-uploading-a-file-to-an-amazon-s3-bucket" id="a_a5da_0" rel="noopener noreferer nofollow">this post</a><span id="span_a5da_2">.</span><br><br id="br_a5da_4"><b id="b_a5da_1">Sample Code</b><br>This is test PHP code to help you comprehend and test transferring to Amazon S3. Requires PHP variant 5.4 or fresher because of exhibit language structure. On the off chance that you need to utilize this in your venture, you ought to most likely alter this and place it into a capacity or strategy. I have it designed like this particularly to help demonstrate how the procedure functions.<br><br>Perused the inline code remarks for a clarification of each segment:<br><br id="br_a5da_9"><pre><code id="code_a5da_0">&lt;?php<br><br><span id="span_a5da_5">//&nbsp;USER&nbsp;OPTIONS</span><br><span id="span_a5da_6">//&nbsp;Replace&nbsp;these&nbsp;values&nbsp;with&nbsp;ones&nbsp;appropriate&nbsp;to&nbsp;you.</span><br>$accessKeyId&nbsp;=&nbsp;'YOUR_ACCESS_KEY_ID';<br>$secretKey&nbsp;=&nbsp;'YOUR_SECRET_KEY';<br>$bucket&nbsp;=&nbsp;'YOUR_BUCKET_NAME';<br>$region&nbsp;=&nbsp;'BUCKET_AMAZON_REGION';&nbsp;<span id="span_a5da_7">//&nbsp;us-west-2,&nbsp;us-east-1,&nbsp;etc</span><br>$acl&nbsp;=&nbsp;'ACCESS_CONTROL_LIST';&nbsp;<span id="span_a5da_8">//&nbsp;private,&nbsp;public-read,&nbsp;etc</span><br>$filePath&nbsp;=&nbsp;'path/to/file.jpg';<br>$fileName&nbsp;=&nbsp;'myimage.jpg';<br>$fileType&nbsp;=&nbsp;'image/jpeg';<br><br><span id="span_a5da_9">//&nbsp;VARIABLES</span><br><span id="span_a5da_10">//&nbsp;These&nbsp;are&nbsp;used&nbsp;throughout&nbsp;the&nbsp;request.</span><br>$longDate&nbsp;=&nbsp;gmdate('Ymd\THis\Z');<br>$shortDate&nbsp;=&nbsp;gmdate('Ymd');<br>$credential&nbsp;=&nbsp;$accessKeyId&nbsp;.&nbsp;'/'&nbsp;.&nbsp;$shortDate&nbsp;.&nbsp;'/'&nbsp;.&nbsp;$region&nbsp;.&nbsp;'/s3/aws4_request';<br><br><span id="span_a5da_11">//&nbsp;POST&nbsp;POLICY</span><br><span id="span_a5da_12">//&nbsp;Amazon&nbsp;requires&nbsp;a&nbsp;base64-encoded&nbsp;POST&nbsp;policy&nbsp;written&nbsp;in&nbsp;JSON.</span><br><span id="span_a5da_13">//&nbsp;This&nbsp;tells&nbsp;Amazon&nbsp;what&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;this&nbsp;request.&nbsp;For</span><br><span id="span_a5da_14">//&nbsp;simplicity,&nbsp;we&nbsp;set&nbsp;the&nbsp;expiration&nbsp;date&nbsp;to&nbsp;always&nbsp;be&nbsp;24H&nbsp;in&nbsp;</span><br><span id="span_a5da_15">//&nbsp;the&nbsp;future.&nbsp;The&nbsp;two&nbsp;"starts-with"&nbsp;fields&nbsp;are&nbsp;used&nbsp;to&nbsp;restrict</span><br><span id="span_a5da_16">//&nbsp;the&nbsp;content&nbsp;of&nbsp;"key"&nbsp;and&nbsp;"Content-Type",&nbsp;which&nbsp;are&nbsp;specified</span><br><span id="span_a5da_17">//&nbsp;later&nbsp;in&nbsp;the&nbsp;POST&nbsp;fields.&nbsp;Again&nbsp;for&nbsp;simplicity,&nbsp;we&nbsp;use&nbsp;blank</span><br><span id="span_a5da_18">//&nbsp;values&nbsp;('')&nbsp;to&nbsp;not&nbsp;put&nbsp;any&nbsp;restrictions&nbsp;on&nbsp;those&nbsp;two&nbsp;fields.</span><br>$policy&nbsp;=&nbsp;base64_encode(json_encode([<br>&nbsp;&nbsp;&nbsp;&nbsp;'expiration'&nbsp;=&gt;&nbsp;gmdate('Y-m-d\TH:i:s\Z',&nbsp;time()&nbsp;+&nbsp;86400),<br>&nbsp;&nbsp;&nbsp;&nbsp;'conditions'&nbsp;=&gt;&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['acl'&nbsp;=&gt;&nbsp;$acl],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['bucket'&nbsp;=&gt;&nbsp;$bucket],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['starts-with',&nbsp;'$Content-Type',&nbsp;''],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['starts-with',&nbsp;'$key',&nbsp;''],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['x-amz-algorithm'&nbsp;=&gt;&nbsp;'AWS4-HMAC-SHA256'],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['x-amz-credential'&nbsp;=&gt;&nbsp;$credential],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;['x-amz-date'&nbsp;=&gt;&nbsp;$longDate]<br>&nbsp;&nbsp;&nbsp;&nbsp;]<br>]));<br><br><span id="span_a5da_19">//&nbsp;SIGNATURE</span><br><span id="span_a5da_20">//&nbsp;A&nbsp;base64-encoded&nbsp;HMAC&nbsp;hashed&nbsp;signature&nbsp;with&nbsp;your&nbsp;secret&nbsp;key.</span><br><span id="span_a5da_21">//&nbsp;This&nbsp;is&nbsp;used&nbsp;so&nbsp;Amazon&nbsp;can&nbsp;verify&nbsp;your&nbsp;request,&nbsp;and&nbsp;will&nbsp;be</span><br><span id="span_a5da_22">//&nbsp;passed&nbsp;along&nbsp;in&nbsp;a&nbsp;POST&nbsp;field&nbsp;later.</span><br>$signingKey&nbsp;=&nbsp;hash_hmac('sha256',&nbsp;$shortDate,&nbsp;'AWS4'&nbsp;.&nbsp;$secretKey,&nbsp;true);<br>$signingKey&nbsp;=&nbsp;hash_hmac('sha256',&nbsp;$region,&nbsp;$signingKey,&nbsp;true);<br>$signingKey&nbsp;=&nbsp;hash_hmac('sha256',&nbsp;'s3',&nbsp;$signingKey,&nbsp;true);<br>$signingKey&nbsp;=&nbsp;hash_hmac('sha256',&nbsp;'aws4_request',&nbsp;$signingKey,&nbsp;true);<br>$signature&nbsp;=&nbsp;hash_hmac('sha256',&nbsp;$policy,&nbsp;$signingKey);<br><br><span id="span_a5da_23">//&nbsp;CURL</span><br><span id="span_a5da_24">//&nbsp;The&nbsp;cURL&nbsp;request.&nbsp;Passes&nbsp;in&nbsp;the&nbsp;full&nbsp;URL&nbsp;to&nbsp;your&nbsp;Amazon&nbsp;bucket.</span><br><span id="span_a5da_25">//&nbsp;Sets&nbsp;RETURNTRANSFER&nbsp;and&nbsp;HEADER&nbsp;to&nbsp;true&nbsp;to&nbsp;see&nbsp;the&nbsp;full&nbsp;response&nbsp;from</span><br><span id="span_a5da_26">//&nbsp;Amazon,&nbsp;including&nbsp;body&nbsp;and&nbsp;head.&nbsp;Sets&nbsp;POST&nbsp;fields&nbsp;for&nbsp;cURL.</span><br><span id="span_a5da_27">//&nbsp;Then&nbsp;executes&nbsp;the&nbsp;cURL&nbsp;request.</span><br>$ch&nbsp;=&nbsp;curl_init('https://'&nbsp;.&nbsp;$bucket&nbsp;.&nbsp;'.s3-'&nbsp;.&nbsp;$region&nbsp;.&nbsp;'.amazonaws.com');<br>curl_setopt($ch,&nbsp;CURLOPT_RETURNTRANSFER,&nbsp;true);<br>curl_setopt($ch,&nbsp;CURLOPT_HEADER,&nbsp;true);<br>curl_setopt($ch,&nbsp;CURLOPT_POST,&nbsp;true);<br>curl_setopt($ch,&nbsp;CURLOPT_POSTFIELDS,&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;'Content-Type'&nbsp;=&gt;&nbsp;&nbsp;$fileType,<br>&nbsp;&nbsp;&nbsp;&nbsp;'acl'&nbsp;=&gt;&nbsp;$acl,<br>&nbsp;&nbsp;&nbsp;&nbsp;'key'&nbsp;=&gt;&nbsp;$fileName,<br>&nbsp;&nbsp;&nbsp;&nbsp;'policy'&nbsp;=&gt;&nbsp;&nbsp;$policy,<br>&nbsp;&nbsp;&nbsp;&nbsp;'x-amz-algorithm'&nbsp;=&gt;&nbsp;'AWS4-HMAC-SHA256',<br>&nbsp;&nbsp;&nbsp;&nbsp;'x-amz-credential'&nbsp;=&gt;&nbsp;$credential,<br>&nbsp;&nbsp;&nbsp;&nbsp;'x-amz-date'&nbsp;=&gt;&nbsp;$longDate,<br>&nbsp;&nbsp;&nbsp;&nbsp;'x-amz-signature'&nbsp;=&gt;&nbsp;$signature,<br>&nbsp;&nbsp;&nbsp;&nbsp;'file'&nbsp;=&gt;&nbsp;new&nbsp;CurlFile(realpath($filePath),&nbsp;$fileType,&nbsp;$fileName)<br>]);<br>$response&nbsp;=&nbsp;curl_exec($ch);<br><br><span id="span_a5da_28">//&nbsp;RESPONSE</span><br><span id="span_a5da_29">//&nbsp;If&nbsp;Amazon&nbsp;returns&nbsp;a&nbsp;response&nbsp;code&nbsp;of&nbsp;204,&nbsp;the&nbsp;request&nbsp;was</span><br><span id="span_a5da_30">//&nbsp;successful&nbsp;and&nbsp;the&nbsp;file&nbsp;should&nbsp;be&nbsp;sitting&nbsp;in&nbsp;your&nbsp;Amazon&nbsp;S3</span><br><span id="span_a5da_31">//&nbsp;bucket.&nbsp;If&nbsp;a&nbsp;code&nbsp;other&nbsp;than&nbsp;204&nbsp;is&nbsp;returned,&nbsp;there&nbsp;will&nbsp;be&nbsp;an</span><br><span id="span_a5da_32">//&nbsp;XML-formatted&nbsp;error&nbsp;code&nbsp;in&nbsp;the&nbsp;body.&nbsp;For&nbsp;simplicity,&nbsp;we&nbsp;use</span><br><span id="span_a5da_33">//&nbsp;substr&nbsp;to&nbsp;extract&nbsp;the&nbsp;error&nbsp;code&nbsp;and&nbsp;output&nbsp;it.</span><br>if&nbsp;(curl_getinfo($ch,&nbsp;CURLINFO_HTTP_CODE)&nbsp;==&nbsp;204)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;'Success!';<br>}&nbsp;else&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;$error&nbsp;=&nbsp;substr($response,&nbsp;strpos($response,&nbsp;'&lt;code&gt;')&nbsp;+&nbsp;6);<br>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;substr($error,&nbsp;0,&nbsp;strpos($error,&nbsp;'&lt;/code&gt;'));<br>}</code></pre><pre><span id="span_a5da_34">If you aren't receiving any response at all, check if&nbsp;</span><samp id="samp_a5da_0">curl_exec($ch)</samp><span id="span_a5da_35">&nbsp;is returning false. If it is, chances are it's due to an SSL issue. You can check the error at&nbsp;</span><samp id="samp_a5da_1">curl_error($ch)</samp><span id="span_a5da_36">. For testing purposes, you can set these two additional cURL options and see if it works:</span></pre><pre><code id="code_a5da_1">curl_setopt($ch,&nbsp;CURLOPT_SSL_VERIFYPEER,&nbsp;false);<br>curl_setopt($ch,&nbsp;CURLOPT_SSL_VERIFYHOST,&nbsp;0);</code></pre><span id="span_a5da_37">But note that doing this is very insecure. Read&nbsp;</span><a href="http://stackoverflow.com/questions/21195530/does-turning-off-curlopt-ssl-verifypeer-in-curl-make-transmission-insecure" id="a_a5da_1" target="_blank" rel="noopener noreferer nofollow">this Stackoverflow post</a><span id="span_a5da_38">&nbsp;and&nbsp;</span><a href="http://unitstep.net/blog/2009/05/05/using-curl-in-php-to-access-https-ssltls-protected-sites/" id="a_a5da_2" target="_blank" rel="noopener noreferer nofollow">this blog post</a><span id="span_a5da_39">.</span><br><br>Source: hex3d.com