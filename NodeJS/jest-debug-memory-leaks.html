<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>debug memory leaks with jest</title><meta name="description" content="debug memory leaks with jest based on stackoverflowYou can try to use --logHeapUsageFrom documentation:Logs the heap usage after every test. Useful to debug memory leaks. Use together with --runInBand and --expose-gc in node.You can try exposing the garbage collector with --expose-gc and addin"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><meta name="keywords" content="the legend of neverland, genshin impact, games, how to, tips and tricks, php, javascript, jquery, mysql, seo, e-commerce"><meta name="image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/2048px-No_image_available.svg.png"><meta name="original-source" content="https://www.webmanajemen.com/NodeJS/jest-debug-memory-leaks.html"><link rel="canonical" href="https://www.webmanajemen.com/NodeJS/jest-debug-memory-leaks.html"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta property="og:title" content="debug memory leaks with jest"><meta property="og:description" content="debug memory leaks with jest based on stackoverflowYou can try to use --logHeapUsageFrom documentation:Logs the heap usage after every test. Useful to debug memory leaks. Use together with --runInBand and --expose-gc in node.You can try exposing the garbage collector with --expose-gc and addin"><meta property="og:url" content="https://www.webmanajemen.com/NodeJS/jest-debug-memory-leaks.html"><meta property="og:site_name" content="WMI"><meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/2048px-No_image_available.svg.png"><!--meta(property='og:image:secure_url' content=thumbnail)--><meta name="twitter:title" content="debug memory leaks with jest"><meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/2048px-No_image_available.svg.png"><meta name="twitter:description" content="debug memory leaks with jest based on stackoverflowYou can try to use --logHeapUsageFrom documentation:Logs the heap usage after every test. Useful to debug memory leaks. Use together with --runInBand and --expose-gc in node.You can try exposing the garbage collector with --expose-gc and addin"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@WebsiteName"><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q || []).push(arguments)},i[r].l=1 * new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-106238155-1', 'auto');
ga('send', 'pageview');</script><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="
  based on stackoverflow
You can try to use --logHeapUsage
From documentation:

Logs the heap usage after every test. Useful to debug memory leaks. Use together with --runInBand and --expose-gc in node.

You can try exposing the garbage collector with --expose-gc and adding
  afterAll(() =&amp;gt; &amp;#123;
  global.gc &amp;amp;&amp;amp; global.gc()
&amp;#125;)

Another opt.."><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="WMI" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="WMI" type="application/rss+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><!--a(href= url_for("/"))= (theme.user && theme.user.name || config.author) + "'s blog"--><a href="/">WMI</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">debug memory leaks with jest</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-to-dump-memory-leaks"><span class="toc-text">Step to dump memory leaks</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/jest"><i class="tag post-item-tag">jest</i></a><a href="/tags/js"><i class="tag post-item-tag">js</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">debug memory leaks with jest</h1><time class="has-text-grey" datetime="2023-05-27T03:04:21.000Z">2023-05-27</time><article class="mt-2 post-content"><details>
  <summary>based on <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.webmanajemen.com/page/safelink.html?url=aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzczNDIwMjg4LzY0MDQ0Mzk=">stackoverflow</a></summary>
<p>You can try to use --logHeapUsage<br>
From <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.webmanajemen.com/page/safelink.html?url=aHR0cHM6Ly9qZXN0anMuaW8vZG9jcy9jbGk=">documentation</a>:</p>
<blockquote>
<p>Logs the heap usage after every test. Useful to debug memory leaks. Use together with --runInBand and --expose-gc in node.</p>
</blockquote>
<p>You can try exposing the garbage collector with --expose-gc and adding</p>
  <pre><code class="highlight plaintext">afterAll(() =&gt; &#123;
  global.gc &amp;&amp; global.gc()
&#125;)
</code></pre>
<p>Another option is <code>jest -w 1</code> to avoid these memory issues.</p>
<blockquote>
<p>–maxWorkers<br>
Alias: -w. Specifies the maximum number of workers the worker-pool will spawn for running tests. In single run mode, this defaults to the number of the cores available on your machine minus one for the main thread. In watch mode, this defaults to half of the available cores on your machine to ensure Jest is unobtrusive and does not grind your machine to a halt. It may be useful to adjust this in resource limited environments like CIs but the defaults should be adequate for most use-cases.<br>
For environments with variable CPUs available, you can use percentage based configuration: --maxWorkers=50%</p>
</blockquote>
<p>References:<br>
<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.webmanajemen.com/page/safelink.html?url=aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNzIwNjgwNTEvY2Fubm90LWZpbmQtbWVtb3J5LWxlYWstaW4tbXktZXhwcmVzcy1qcy1qZXN0LXRlc3Rz">Cannot find memory leak in my Express.js Jest tests</a><br>
<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.webmanajemen.com/page/safelink.html?url=aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNjI4ODUzOTAvbXktamVzdHMtdGVzdHMtYXJlLWxlYWtpbmctbWVtb3J5LWhvdy1jYW4taS1maXgtdGhpcw==">My Jests tests are leaking memory, how can I fix this?</a><br>
<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.webmanajemen.com/page/safelink.html?url=aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTM4NTMxMjUvd2hhdC1hcmUtdGhlLXN0ZXBzLXRvLWZvbGxvdy10by1kZWJ1Zy1tZW1vcnktbGVhay1pbi1qZXN0">What are the steps to follow to debug memory leak in Jest?</a><br>
<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.webmanajemen.com/page/safelink.html?url=aHR0cHM6Ly9jaGFuaW5kLmdpdGh1Yi5pby9qYXZhc2NyaXB0LzIwMTkvMTAvMTIvamVzdC10ZXN0cy1tZW1vcnktbGVhay5odG1s">https://chanind.github.io/javascript/2019/10/12/jest-tests-memory-leak.html</a></p>
</details>
<h2 id="Step-to-dump-memory-leaks">Step to dump memory leaks</h2>
<blockquote>
<p>If you haven’t installed <code>jest</code>, please read <a href="https://www.webmanajemen.com/2023/04/setup-jest-code-runner-vscode.html">https://www.webmanajemen.com/2023/04/setup-jest-code-runner-vscode.html</a></p>
</blockquote>
<ul>
<li>create new test file</li>
</ul>
<pre><code class="highlight ts"><span class="keyword">import</span> &#123; afterAll, describe, expect, it &#125; <span class="keyword">from</span> <span class="string">&#x27;@jest/globals&#x27;</span>;
<span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;
<span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;
<span class="keyword">import</span> &#123; testcfg &#125; <span class="keyword">from</span> <span class="string">&#x27;./config&#x27;</span>;

<span class="title function_">describe</span>(<span class="string">&#x27;.gitignore test&#x27;</span>, <span class="function">() =&gt;</span> &#123;
  <span class="keyword">const</span> ignoredFile = <span class="title function_">join</span>(testcfg.<span class="property">cwd</span>, <span class="string">&#x27;file-ignore.txt&#x27;</span>);
  <span class="keyword">const</span> ignoredFile2 = <span class="title function_">join</span>(testcfg.<span class="property">cwd</span>, <span class="string">&#x27;file-ignore-another.txt&#x27;</span>);

  <span class="title function_">it</span>(<span class="string">&#x27;write&#x27;</span>, <span class="function">() =&gt;</span> &#123;
    fs.<span class="title function_">writeFileSync</span>(ignoredFile, <span class="string">&#x27;&#x27;</span>);
    fs.<span class="title function_">writeFileSync</span>(ignoredFile2, <span class="string">&#x27;&#x27;</span>);
    <span class="title function_">expect</span>(fs.<span class="title function_">existsSync</span>(ignoredFile)).<span class="title function_">toBeTruthy</span>();
    <span class="title function_">expect</span>(fs.<span class="title function_">existsSync</span>(ignoredFile2)).<span class="title function_">toBeTruthy</span>();
  &#125;, <span class="number">900000</span>);

  <span class="title function_">afterAll</span>(<span class="function">() =&gt;</span> &#123;
    <span class="keyword">if</span> (<span class="variable language_">global</span>.<span class="property">gc</span>) &#123;
      <span class="variable language_">global</span>.<span class="title function_">gc</span>();
    &#125;
  &#125;);
&#125;);</code></pre>
<ul>
<li>run using below command</li>
</ul>
<pre><code class="highlight bash">node --expose-gc ./node_modules/jest-cli/bin/jest.js --logHeapUsage -- test-file-name</code></pre>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/GitHub/git-detach-subfolder-to-their-own-repository.html" title="git detach subfolder to their own repository"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: git detach subfolder to their own repository</span></a><a class="button is-default" href="/hexo/hexo-run-custom-script-after-site-generated.html" title="hexo run custom script after site generated"><span class="has-text-weight-semibold">Next: hexo run custom script after site generated</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><!--section.related-posts= getRelatedPost(page)--><div id="disqus_thread"></div><article class="mt-6 comment-container" id="disqus"><script>var disqus_config = function () { this.page.url = 'https://www.webmanajemen.com/NodeJS/jest-debug-memory-leaks.html'; this.page.identifier = 'dimaslanjaka'; this.page.title = document.title; };</script><script>(function() {var d = document, s = d.createElement('script');s.src = '//dimaslanjaka.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s);})();</script><script id="dsq-count-scr" src="//blog-pubgj2togw.disqus.com/count.js" async></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/dimaslanjaka"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//dimaslanjaka1"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Dimas Lanjaka 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap hidden"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" href="//github.com/haojen" rel="nofollow noopener noopener">Theme by Haojen&nbsp;</a><a title="Hexo theme contributor" target="_blank" href="//github.com/dimaslanjaka" rel="nofollow noopener noopener">Modded by L3n4r0x&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" href="https://www.webmanajemen.com/page/safelink.html?url=aHR0cHM6Ly9naXRodWIuY29tL0hhb2plbi9oZXhvLXRoZW1lLUNsYXVkaWE=" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true" rel="nofollow noopener noopener"></a></div></div><div><span></span></div></footer><!-- script(async defer src="//buttons.github.io/buttons.js")--><script src="//www.webmanajemen.com/page/assets/js/r-ads.js" type="text/javascript"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script>
<script src="/hexo-shortcodes-lib/githubcard.js"></script>
<link rel="stylesheet" href="/hexo-shortcodes-lib/gist.css" />
</body>
      </html>